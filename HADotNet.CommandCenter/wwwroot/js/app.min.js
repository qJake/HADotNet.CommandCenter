var PageMode,__app,WeatherTileEntities;(function(n){n[n.User=0]="User";n[n.Admin=1]="Admin"})(PageMode||(PageMode={}));class Utils{static delayPromise(n,...t){return new Promise(i=>setTimeout(()=>i(t),n))}static resolveIcon(n,t){return t&&t.length?t:n&&n.length&&/^mdi:/i.test(n)?n.replace("mdi:",""):""}static preloadImage(n){return new Promise((t,i)=>{let r=new Image;r.onload=()=>t(n);r.onerror=n=>i(n);r.src=n})}static convertDegreesToCardinal(n){return["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"][Math.floor(n/22.5+.5)%16]}static convertCardinalToIcon(n){return{N:"arrow-up-thick",NNE:"arrow-up-thick",NE:"arrow-top-right-thick",ENE:"arrow-right-thick",E:"arrow-right-thick",ESE:"arrow-right-thick",SE:"arrow-bottom-right-thick",SSE:"arrow-down-thick",S:"arrow-down-thick",SSW:"arrow-down-thick",SW:"arrow-bottom-left-thick",WSW:"arrow-left-thick",W:"arrow-left-thick",WNW:"arrow-left-thick",NW:"arrow-top-left-thick",NNW:"arrow-up-thick"}[n]}}class Tile{constructor(n,t,i=true){this.name=n;this.conn=t;this.canLoad=i;this.el=$(`.tiles .tile[data-tile-name="${n}"]`);i&&this.el.click(()=>{this.onClick().then(()=>Utils.delayPromise(500)).then(()=>{this.requestState(1e3)})});t.on("SendSystemConfig",(t,i)=>{n==t&&(this.config=i)});t.on("SendTileState",(t,i)=>{n==t.name&&this.updateState(t,i)});t.on("SendTileStates",(t,i)=>{n==t.name&&this.updateStates(t,i)});t.on("SendWarning",n=>console.warn(n));t.on("SendDateTime",(t,i,r)=>{n==t.name&&this.updateState(t,i,r)});this.canLoad&&this.requestState()}onClick(){return this.conn.invoke("OnTileClicked",this.name)}updateState(){this.disableLoading()}updateStates(){this.disableLoading()}requestState(n){this.enableLoading(n);this.conn.invoke("RequestTileState",this.name)}requestConfig(){this.conn.invoke("RequestConfig",this.name)}enableLoading(n){this.el.hasClass("tile-loading")||this.loadingDebouncer||(n||this.debounceTimeMs?this.loadingDebouncer=window.setTimeout(()=>{this.el.addClass("tile-loading")},n||this.debounceTimeMs):this.el.addClass("tile-loading"))}disableLoading(){this.loadingDebouncer&&window.clearTimeout(this.loadingDebouncer);this.loadingDebouncer=null;this.el.removeClass("tile-loading")}}class BlankTile extends Tile{constructor(n,t){super(n,t,!1)}}class LabelTile extends Tile{constructor(n,t){super(n,t,!1)}}class DateTile extends Tile{updateState(n,t,i){$(`#tile-${n.name}`).find("span[value-date]").text(t);$(`#tile-${n.name}`).find("span[value-time]").text(i);super.updateState();setTimeout(()=>{this.requestState(9500)},1e4)}}class StateTile extends Tile{updateState(n,t){let i=t.attributes.friendly_name.toString();n.overrideLabel&&(i=n.overrideLabel);$(`#tile-${n.name}`).find("span[value-name]").text(i);let r=t.state;t.attributes.unit_of_measurement&&(r+=t.attributes.unit_of_measurement.toString());$(`#tile-${n.name}`).find("span[value-state]").text(r);super.updateState();n.refreshRate>0&&setTimeout(()=>{this.requestState(1e3)},n.refreshRate*1e3)}}class LightTile extends Tile{updateState(n,t){var i=n;let r=t.attributes.friendly_name.toString();n.overrideLabel&&(r=n.overrideLabel);$(`#tile-${n.name}`).find("span[value-name]").text(r);$(`#tile-${n.name}`).find("span[value-icon]").removeClass(`mdi-${i.displayIcon} mdi-${i.displayOffIcon}`).addClass(`mdi mdi-${t.state.toLowerCase()==="on"?Utils.resolveIcon(t.attributes.icon,i.displayIcon):Utils.resolveIcon(t.attributes.icon,i.displayOffIcon||i.displayIcon)}`);$(`#tile-${n.name}`).find("span[value-icon]").removeClass("state-off state-on").addClass(t.state.toLowerCase()==="on"?"state-on":"state-off");i.onColor&&t.state.toLowerCase()==="on"&&$(`#tile-${n.name} .value`).css("color",i.onColor);i.offColor&&t.state.toLowerCase()!=="on"&&$(`#tile-${n.name} .value`).css("color",i.offColor);super.updateState();n.refreshRate>0&&setTimeout(()=>{this.requestState(2e3)},n.refreshRate*1e3)}}class SwitchTile extends Tile{updateState(n,t){var i=n;let r=t.attributes.friendly_name.toString();n.overrideLabel&&(r=n.overrideLabel);$(`#tile-${n.name}`).find("span[value-name]").text(r);$(`#tile-${n.name}`).find("span[value-icon]").removeClass(`mdi-${i.displayIcon} mdi-${i.displayOffIcon}`).addClass(`mdi mdi-${t.state.toLowerCase()==="on"?Utils.resolveIcon(t.attributes.icon,i.displayIcon):Utils.resolveIcon(t.attributes.icon,i.displayOffIcon||i.displayIcon)}`);$(`#tile-${n.name}`).find("span[value-icon]").removeClass("state-off state-on").addClass(t.state.toLowerCase()==="on"?"state-on":"state-off");i.onColor&&t.state.toLowerCase()==="on"&&$(`#tile-${n.name} .value`).css("color",i.onColor);i.offColor&&t.state.toLowerCase()!=="on"&&$(`#tile-${n.name} .value`).css("color",i.offColor);super.updateState();n.refreshRate>0&&setTimeout(()=>{this.requestState(2e3)},n.refreshRate*1e3)}}class PersonTile extends Tile{updateState(n,t){let u=t.attributes.entity_picture.toString(),i=t.state,r=t.attributes.friendly_name.toString();n.overrideLabel&&(r=n.overrideLabel);let f=i.toLowerCase()==="home";$(`#tile-${n.name}`).find("span[value-name]").text(r);$(`#tile-${n.name}`).find("span[value-location]").text(i);$(`#tile-${n.name}`).find("span[value-picture]").css("background-image",`url(${u})`).removeClass("bw");f||$(`#tile-${n.name}`).find("span[value-picture]").addClass("bw");super.updateState();n.refreshRate>0&&setTimeout(()=>{this.requestState(2e3)},n.refreshRate*1e3)}}class WeatherTile extends Tile{constructor(n,t,i=true){super(n,t,i);this.name=n;this.conn=t;this.canLoad=i;this.iconEl=this.el.find(".condition-icon")[0];const r=document.defaultView.getComputedStyle(this.el[0]).color;this.skycons=new Skycons({color:r,resizeClear:!0});this.skycons.add(this.iconEl,Skycons.CLEAR_DAY)}updateStates(n,t){let f="",i="",r="",u="";for(let e in t){let o=t[e]==null?null:t[e].state;switch(e){case WeatherTileEntities.entityId:t[e].attributes.unit_of_measurement&&(o+=t[e].attributes.unit_of_measurement.toString());$(`#tile-${n.name}`).find("span[value-temp]").text(o);break;case WeatherTileEntities.highTempEntity:t[e].attributes.unit_of_measurement&&(o+=t[e].attributes.unit_of_measurement.toString());r=`<i class="mdi mdi-arrow-up-thick"></i> ${o}`;break;case WeatherTileEntities.lowTempEntity:t[e].attributes.unit_of_measurement&&(o+=t[e].attributes.unit_of_measurement.toString());u=`<i class="mdi mdi-arrow-down-thick"></i> ${o}`;break;case WeatherTileEntities.summaryEntity:$(`#tile-${n.name}`).find("span[value-summary]").text(o);break;case WeatherTileEntities.precipChanceEntity:t[e].attributes.unit_of_measurement&&(o+=t[e].attributes.unit_of_measurement.toString());$(`#tile-${n.name}`).find("span[value-rain]").text(`Rain: ${o}`);break;case WeatherTileEntities.windSpeedEntity:t[e].attributes.unit_of_measurement&&(o+=t[e].attributes.unit_of_measurement.toString());f=o;break;case WeatherTileEntities.windDirectionEntity:i=Utils.convertDegreesToCardinal(parseInt(o));i=`<i class="mdi mdi-${Utils.convertCardinalToIcon(i)}"></i> ${i}`;break;case WeatherTileEntities.iconEntity:o?(this.skycons.set(this.iconEl,o),this.skycons.play()):(this.skycons.remove(this.iconEl),$(this.iconEl).hide())}}$(`#tile-${n.name}`).find("span[value-hi-lo]").html(`${r&&u?r+" / "+u:r+u}`);$(`#tile-${n.name}`).find("span[value-wind]").html(`Wind: ${(f+" "+i).trim()}`);super.updateState();n.refreshRate>0&&setTimeout(()=>{this.requestState(2e3)},n.refreshRate*1e3)}}class CameraTile extends Tile{constructor(n,t){super(n,t,!0);this.firstLoadIgnored=!1;this.requestConfig()}updateState(n,t){var i=n;if(this.config&&this.config.baseUrl){const r=Math.floor(Math.random()*Math.floor(99999999));let u=this.config.baseUrl+t.attributes.entity_picture.toString()+"&_nocache="+r;Utils.preloadImage(u).then(t=>{let r=i.imageCropMode.toLowerCase()==="cover"||i.imageCropMode.toLowerCase()==="contain"?i.imageCropMode.toLowerCase():"100% 100%",u=i.imageCropMode.toLowerCase()==="cover"||i.imageCropMode.toLowerCase()==="contain"?"50% 50%":"0 0";$(`#tile-${n.name}`).css({backgroundImage:`url('${t}')`,backgroundRepeat:"no-repeat",backgroundPosition:u,backgroundSize:r})}).finally(()=>this.queueTileRefresh(n,!0))}else this.firstLoadIgnored?console.warn("Missing config.baseUrl, unable to render camera display.",this.config):this.firstLoadIgnored=!0,this.queueTileRefresh(n)}queueTileRefresh(n,t){t&&super.updateState();n.refreshRate>0&&setTimeout(()=>{this.requestState(n.refreshRate*1e3-100)},n.refreshRate*1e3)}}class TileMap{}TileMap.ClassMap={Blank:BlankTile,Label:LabelTile,Date:DateTile,State:StateTile,Light:LightTile,Switch:SwitchTile,Person:PersonTile,Weather:WeatherTile,Camera:CameraTile};class CommandCenter{constructor(){this.tiles=[];$(()=>this.init())}init(){window.ccOptions.mode==PageMode.Admin?this.initAdmin():this.initUser();this.initializeMdiPreview();this.initializeColorPreview()}initAdmin(){$(window).on("beforeunload",n=>{if(this.pageIsDirty&&$(n.target.activeElement).prop("type")!=="submit")return"You have unsaved changes. Are you sure you want to leave?"});if($(".ui.accordion").accordion(),$(".ui.checkbox").checkbox(),$(".ui.dropdown").not(".no-placeholder").dropdown({fullTextSearch:!0}),$(".ui.no-placeholder.dropdown").dropdown({placeholder:!1}),$("#Page_PageFontFace option").each(function(n,t){$(t).parent().siblings(".menu").find('.item[data-value="'+$(t).text()+'"]').css("font-family",$(t).text())}),$(".preview-layout-grid").length){$("#auto-layout").click(()=>this.pk.layout());$(".preview-layout-grid").prepend(`<div class="preview-layout-item" style="opacity: 0; position: absolute; top: ${window.ccOptions.tilePreviewPadding}px; left: ${window.ccOptions.tilePreviewPadding}px; width: ${window.ccOptions.tilePreviewSize}px; height: ${window.ccOptions.tilePreviewSize}px;" id="grid__tmp"></div>`);this.pk=new Packery(".preview-layout-grid",{itemSelector:".preview-layout-item",columnWidth:".preview-layout-item",rowHeight:".preview-layout-item",gutter:window.ccOptions.tilePreviewPadding,initLayout:!1});this.pk.on("layoutComplete",()=>this.writeItemLayout());this.pk.on("dragItemPositioned",()=>{setTimeout(()=>{this.writeItemLayout(),this.pageIsDirty=!0},25)});this.writeItemLayout();typeof Draggabilly=="function"?$(".preview-layout-item").each((n,t)=>this.pk.bindDraggabillyEvents(new Draggabilly(t,{containment:".preview-layout-grid"}))):console.warn("Draggabilly is not available - drag and drop interface will not work.");$("#grid__tmp").remove();this.pk.initShiftLayout(Array.from(document.querySelectorAll(".preview-layout-grid > .preview-layout-item")))}}initUser(){this.tileConn=(new signalR.HubConnectionBuilder).withUrl("/hubs/tile").build();this.tileConn.start().then(()=>{$(".tiles .tile").each((n,t)=>{try{let n=new TileMap.ClassMap[$(t).data("tile-type").toString()]($(t).data("tile-name"),this.tileConn);this.tiles.push(n)}catch(i){console.error('Error instantiating class "'+($(t).data("tile-type")||"__MISSING__")+'Tile". Was it added to the tile type map?',i,t)}})})}initializeMdiPreview(){$(".mdi-icon-placeholder + input").each((n,t)=>{$(t).keyup(n=>{this.refreshDynamicIcon(n.currentTarget)}),this.refreshDynamicIcon(t)})}refreshDynamicIcon(n){$(n).parent().children(".mdi-icon-placeholder").attr("class","large icon mdi-icon-placeholder").addClass(`mdi mdi-${$(n).val()}`)}initializeColorPreview(){$(".color-preview + input").each((n,t)=>{$(t).keyup(n=>{this.refreshDynamicColor(n.currentTarget)}),this.refreshDynamicColor(t)})}refreshDynamicColor(n){$(n).parent().children(".color-preview").css("color",`${$(n).val()}`)}writeItemLayout(){var n=[],t=this.pk.getItemElements();for(let i=0;i<t.length;i++){let r=$(t[i]);n.push({index:i,x:parseInt(r.css("left").replace("px","")),y:parseInt(r.css("top").replace("px","")),name:r.data("tile-name")})}$("#layout-serialized").val(JSON.stringify(n))}}__app=new CommandCenter;Packery.prototype.initShiftLayout=function(n){this._resetLayout();this.items=n.map(function(n){var t=this.getItem(n);let i=parseInt(n.style.left.replace("px","")),r=parseInt(n.style.top.replace("px","")),u=n.clientWidth,f=n.clientHeight;return t.rect.x=i-this.gutter,t.rect.y=r,t.rect.height=f,t.rect.width=u,t.position.x=i-this.gutter,t.position.y=r,t},this);this.shiftLayout()},function(n){n.entityId="entityId";n.iconEntity="iconEntity";n.summaryEntity="summaryEntity";n.precipChanceEntity="precipChanceEntity";n.highTempEntity="highTempEntity";n.lowTempEntity="lowTempEntity";n.windSpeedEntity="windSpeedEntity";n.windDirectionEntity="windDirectionEntity"}(WeatherTileEntities||(WeatherTileEntities={}));